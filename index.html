<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="Space Invaders - Classic arcade game reimagined for modern browsers with touch controls">
    <meta name="keywords" content="space invaders, arcade game, html5 game, canvas game, retro gaming">
    <meta name="author" content="Space Invaders JS Team">
    <meta name="theme-color" content="#000000">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- Performance Optimization -->
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    
    <!-- Progressive Web App -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Space Invaders">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    
    <title>Space Invaders - HTML5 Canvas Game</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="js/game.js" as="script">
    <link rel="preload" href="js/renderer.js" as="script">
    <link rel="preload" href="js/config/gameConfig.js" as="script">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen" role="status" aria-label="Game loading">
        <div class="loading-container">
            <div class="loading-logo">
                <h1>SPACE INVADERS</h1>
                <div class="loading-subtitle">HTML5 Edition</div>
            </div>
            <div class="loading-progress">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div id="loading-text" class="loading-text">Initializing game systems...</div>
                <div id="loading-percentage" class="loading-percentage">0%</div>
            </div>
            <div class="loading-tips">
                <div id="loading-tip" class="loading-tip">
                    Use arrow keys or WASD to move, spacebar to shoot!
                </div>
            </div>
        </div>
        
        <!-- Loading Animation -->
        <div class="stars-background">
            <div class="star star-1"></div>
            <div class="star star-2"></div>
            <div class="star star-3"></div>
            <div class="star star-4"></div>
            <div class="star star-5"></div>
        </div>
    </div>

    <!-- Game Container -->
    <div id="game-container" class="game-container" style="display: none;">
        <!-- Game Canvas -->
        <canvas 
            id="game-canvas" 
            class="game-canvas"
            width="800" 
            height="600"
            role="img"
            aria-label="Space Invaders game area"
            tabindex="0"
        >
            <p class="canvas-fallback">
                Your browser does not support HTML5 Canvas. 
                Please upgrade to a modern browser to play Space Invaders.
                <br>
                <a href="https://browsehappy.com/" target="_blank" rel="noopener noreferrer">
                    Get a modern browser
                </a>
            </p>
        </canvas>

        <!-- Game UI Overlay -->
        <div id="game-ui" class="game-ui" aria-live="polite">
            <!-- Score Display -->
            <div class="ui-top">
                <div class="score-container">
                    <span class="score-label">SCORE</span>
                    <span id="score-display" class="score-value">000000</span>
                </div>
                <div class="lives-container">
                    <span class="lives-label">LIVES</span>
                    <div id="lives-display" class="lives-icons">
                        <span class="life-icon">‚ô¶</span>
                        <span class="life-icon">‚ô¶</span>
                        <span class="life-icon">‚ô¶</span>
                    </div>
                </div>
                <div class="wave-container">
                    <span class="wave-label">WAVE</span>
                    <span id="wave-display" class="wave-value">1</span>
                </div>
            </div>

            <!-- Game Messages -->
            <div id="game-messages" class="game-messages" role="alert" aria-live="assertive">
                <!-- Dynamic messages will be inserted here -->
            </div>

            <!-- Pause Menu -->
            <div id="pause-menu" class="pause-menu" style="display: none;" role="dialog" aria-labelledby="pause-title">
                <div class="menu-content">
                    <h2 id="pause-title">GAME PAUSED</h2>
                    <div class="menu-buttons">
                        <button id="resume-btn" class="menu-button" type="button">RESUME</button>
                        <button id="restart-btn" class="menu-button" type="button">RESTART</button>
                        <button id="settings-btn" class="menu-button" type="button">SETTINGS</button>
                    </div>
                </div>
            </div>

            <!-- Game Over Screen -->
            <div id="game-over" class="game-over" style="display: none;" role="dialog" aria-labelledby="game-over-title">
                <div class="game-over-content">
                    <h2 id="game-over-title">GAME OVER</h2>
                    <div class="final-score">
                        <span class="final-score-label">FINAL SCORE</span>
                        <span id="final-score-value" class="final-score-value">000000</span>
                    </div>
                    <div class="game-over-buttons">
                        <button id="play-again-btn" class="menu-button primary" type="button">PLAY AGAIN</button>
                        <button id="main-menu-btn" class="menu-button" type="button">MAIN MENU</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Touch Controls for Mobile -->
        <div id="touch-controls" class="touch-controls" style="display: none;">
            <div class="touch-controls-left">
                <div class="dpad">
                    <button id="touch-left" class="dpad-button dpad-left" type="button" aria-label="Move left">
                        <span class="dpad-arrow">‚óÄ</span>
                    </button>
                    <button id="touch-right" class="dpad-button dpad-right" type="button" aria-label="Move right">
                        <span class="dpad-arrow">‚ñ∂</span>
                    </button>
                </div>
            </div>
            <div class="touch-controls-right">
                <button id="touch-shoot" class="action-button shoot-button" type="button" aria-label="Shoot">
                    <span class="button-icon">üöÄ</span>
                    <span class="button-label">SHOOT</span>
                </button>
                <button id="touch-pause" class="action-button pause-button" type="button" aria-label="Pause game">
                    <span class="button-icon">‚è∏</span>
                </button>
            </div>
        </div>

        <!-- Performance Monitor (Development) -->
        <div id="performance-monitor" class="performance-monitor" style="display: none;">
            <div class="perf-item">
                <span class="perf-label">FPS:</span>
                <span id="fps-counter" class="perf-value">60</span>
            </div>
            <div class="perf-item">
                <span class="perf-label">Frame Time:</span>
                <span id="frame-time" class="perf-value">16ms</span>
            </div>
            <div class="perf-item">
                <span class="perf-label">Entities:</span>
                <span id="entity-count" class="perf-value">0</span>
            </div>
        </div>
    </div>

    <!-- Error Boundary -->
    <div id="error-boundary" class="error-boundary" style="display: none;" role="alert">
        <div class="error-content">
            <h2>Oops! Something went wrong</h2>
            <p id="error-message">An unexpected error occurred while running the game.</p>
            <div class="error-actions">
                <button id="reload-game-btn" class="error-button primary" type="button">Reload Game</button>
                <button id="report-error-btn" class="error-button" type="button">Report Issue</button>
            </div>
            <details class="error-details">
                <summary>Technical Details</summary>
                <pre id="error-stack" class="error-stack"></pre>
            </details>
        </div>
    </div>

    <!-- Accessibility Announcements -->
    <div id="screen-reader-announcements" class="sr-only" aria-live="polite" aria-atomic="true">
        <!-- Screen reader announcements will be inserted here -->
    </div>

    <!-- Scripts -->
    <script type="module">
        /**
         * Main application bootstrap and initialization
         * Handles loading, error boundaries, and game lifecycle
         */
        
        // Global error handling
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showErrorBoundary(event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showErrorBoundary(event.reason);
        });

        // Loading state management
        const loadingTips = [
            "Use arrow keys or WASD to move, spacebar to shoot!",
            "Destroy enemies to earn points and advance waves!",
            "Watch out for faster enemies in later waves!",
            "Take cover behind barriers, but they can be destroyed!",
            "Bonus points for accuracy and speed!",
            "Touch controls available on mobile devices!"
        ];

        let currentTipIndex = 0;
        let loadingProgress = 0;

        function updateLoadingProgress(progress, message) {
            loadingProgress = Math.min(100, Math.max(0, progress));
            
            const progressFill = document.getElementById('progress-fill');
            const loadingText = document.getElementById('loading-text');
            const loadingPercentage = document.getElementById('loading-percentage');
            
            if (progressFill) {
                progressFill.style.width = `${loadingProgress}%`;
                progressFill.setAttribute('aria-valuenow', loadingProgress);
            }
            
            if (loadingText && message) {
                loadingText.textContent = message;
            }
            
            if (loadingPercentage) {
                loadingPercentage.textContent = `${Math.round(loadingProgress)}%`;
            }
        }

        function rotateTips() {
            const tipElement = document.getElementById('loading-tip');
            if (tipElement && loadingTips.length > 0) {
                currentTipIndex = (currentTipIndex + 1) % loadingTips.length;
                tipElement.textContent = loadingTips[currentTipIndex];
            }
        }

        function showErrorBoundary(error) {
            const errorBoundary = document.getElementById('error-boundary');
            const errorMessage = document.getElementById('error-message');
            const errorStack = document.getElementById('error-stack');
            const gameContainer = document.getElementById('game-container');
            const loadingScreen = document.getElementById('loading-screen');
            
            if (errorBoundary) {
                errorBoundary.style.display = 'flex';
            }
            
            if (gameContainer) {
                gameContainer.style.display = 'none';
            }
            
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            if (errorMessage) {
                errorMessage.textContent = error?.message || 'An unexpected error occurred.';
            }
            
            if (errorStack && error?.stack) {
                errorStack.textContent = error.stack;
            }
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            const gameContainer = document.getElementById('game-container');
            
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    if (gameContainer) {
                        gameContainer.style.display = 'block';
                        gameContainer.style.opacity = '0';
                        requestAnimationFrame(() => {
                            gameContainer.style.opacity = '1';
                        });
                    }
                }, 500);
            }
        }

        function detectTouchDevice() {
            return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        }

        function showTouchControls() {
            const touchControls = document.getElementById('touch-controls');
            if (touchControls && detectTouchDevice()) {
                touchControls.style.display = 'flex';
            }
        }

        // Initialize error boundary event handlers
        function initializeErrorHandlers() {
            const reloadBtn = document.getElementById('reload-game-btn');
            const reportBtn = document.getElementById('report-error-btn');
            
            if (reloadBtn) {
                reloadBtn.addEventListener('click', () => {
                    window.location.reload();
                });
            }
            
            if (reportBtn) {
                reportBtn.addEventListener('click', () => {
                    // In a real application, this would send error reports to a logging service
                    console.log('Error report requested');
                    alert('Error reporting is not implemented in this demo version.');
                });
            }
        }

        // Canvas validation and setup
        function validateCanvas() {
            const canvas = document.getElementById('game-canvas');
            if (!canvas) {
                throw new Error('Game canvas element not found');
            }
            
            const context = canvas.getContext('2d');
            if (!context) {
                throw new Error('Canvas 2D context not supported');
            }
            
            return { canvas, context };
        }

        // Main initialization function
        async function initializeGame() {
            try {
                updateLoadingProgress(10, 'Validating browser compatibility...');
                
                // Validate canvas support
                const { canvas, context } = validateCanvas();
                
                updateLoadingProgress(20, 'Loading game configuration...');
                
                // Import and initialize game modules
                const { gameConfig } = await import('./js/config/gameConfig.js');
                updateLoadingProgress(40, 'Initializing renderer...');
                
                const { Renderer } = await import('./js/renderer.js');
                updateLoadingProgress(60, 'Setting up game systems...');
                
                const { Game } = await import('./js/game.js');
                updateLoadingProgress(80, 'Preparing game world...');
                
                // Initialize game instance
                const renderer = new Renderer(canvas);
                const game = new Game(renderer, gameConfig);
                
                updateLoadingProgress(90, 'Finalizing setup...');
                
                // Setup touch controls for mobile
                showTouchControls();
                
                updateLoadingProgress(100, 'Ready to play!');
                
                // Hide loading screen and show game
                setTimeout(() => {
                    hideLoadingScreen();
                    
                    // Start the game
                    game.start();
                    
                    // Focus canvas for keyboard input
                    canvas.focus();
                    
                }, 1000);
                
            } catch (error) {
                console.error('Failed to initialize game:', error);
                showErrorBoundary(error);
            }
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeErrorHandlers();
                
                // Start tip rotation
                setInterval(rotateTips, 3000);
                
                // Begin game initialization
                setTimeout(initializeGame, 500);
            });
        } else {
            initializeErrorHandlers();
            setInterval(rotateTips, 3000);
            setTimeout(initializeGame, 500);
        }

        // Performance monitoring toggle (development)
        if (window.location.search.includes('debug=true')) {
            const perfMonitor = document.getElementById('performance-monitor');
            if (perfMonitor) {
                perfMonitor.style.display = 'block';
            }
        }

        // Accessibility enhancements
        function announceToScreenReader(message) {
            const announcements = document.getElementById('screen-reader-announcements');
            if (announcements) {
                announcements.textContent = message;
            }
        }

        // Export for global access
        window.SpaceInvaders = {
            announceToScreenReader,
            updateLoadingProgress,
            showErrorBoundary
        };

    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>