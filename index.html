<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Space Invaders - Classic arcade game reimagined for modern browsers">
    <meta name="keywords" content="space invaders, arcade game, html5 game, canvas game">
    <meta name="author" content="Space Invaders JS Team">
    <meta name="theme-color" content="#000000">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; connect-src 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="css/styles.css" as="style">
    <link rel="preload" href="js/game.js" as="script">
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    
    <title>Space Invaders - HTML5 Canvas Game</title>
    
    <!-- Critical CSS Inline for Performance -->
    <style>
        /* Critical rendering path styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #00ff00;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: manipulation;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(ellipse at center, #0f3460 0%, #0c0c0c 100%);
        }
        
        #gameCanvas {
            border: 2px solid #00ff00;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            background: #000;
            max-width: 100vw;
            max-height: 100vh;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
        }
        
        #loadingScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 255, 0, 0.3);
            border-top: 3px solid #00ff00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(0, 255, 0, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00cc00);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        /* Touch Controls */
        .touch-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 20px;
            z-index: 100;
        }
        
        .touch-button {
            width: 60px;
            height: 60px;
            border: 2px solid #00ff00;
            border-radius: 50%;
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
        }
        
        .touch-button:active {
            background: rgba(0, 255, 0, 0.3);
            transform: scale(0.95);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
        }
        
        .touch-button.pressed {
            background: rgba(0, 255, 0, 0.4);
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.8);
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .touch-controls {
                display: flex;
            }
            
            #gameCanvas {
                border-radius: 0;
                border: none;
                width: 100vw;
                height: 100vh;
            }
            
            #gameContainer {
                padding: 0;
            }
        }
        
        /* High DPI Display Support */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            #gameCanvas {
                image-rendering: auto;
            }
        }
        
        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            .loading-spinner {
                animation: none;
            }
            
            .touch-button {
                transition: none;
            }
        }
        
        /* Error Screen */
        .error-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
            padding: 20px;
        }
        
        .error-title {
            font-size: 24px;
            color: #ff4444;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }
        
        .error-message {
            font-size: 16px;
            color: #cccccc;
            margin-bottom: 30px;
            max-width: 400px;
            line-height: 1.5;
        }
        
        .retry-button {
            padding: 12px 24px;
            background: transparent;
            border: 2px solid #00ff00;
            color: #00ff00;
            font-family: inherit;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .retry-button:hover {
            background: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- Game Container -->
    <div id="gameContainer">
        <!-- Main Game Canvas -->
        <canvas id="gameCanvas" width="800" height="600" role="img" aria-label="Space Invaders Game Canvas">
            <p>Your browser does not support the HTML5 Canvas element. Please upgrade to a modern browser to play Space Invaders.</p>
        </canvas>
        
        <!-- Loading Screen -->
        <div id="loadingScreen" aria-live="polite" aria-label="Game Loading">
            <div class="loading-spinner" aria-hidden="true"></div>
            <div class="loading-text" id="loadingText">Initializing Space Invaders...</div>
            <div class="loading-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                <div class="loading-progress-bar" id="loadingProgressBar"></div>
            </div>
        </div>
        
        <!-- Error Screen -->
        <div id="errorScreen" class="error-screen" role="alert" aria-live="assertive">
            <div class="error-title">Game Error</div>
            <div class="error-message" id="errorMessage">An unexpected error occurred while loading the game.</div>
            <button class="retry-button" id="retryButton" onclick="window.location.reload()">Retry</button>
        </div>
        
        <!-- Touch Controls for Mobile -->
        <div class="touch-controls" id="touchControls" aria-label="Touch Controls">
            <button class="touch-button" id="touchLeft" data-key="ArrowLeft" aria-label="Move Left">←</button>
            <button class="touch-button" id="touchShoot" data-key="Space" aria-label="Shoot">●</button>
            <button class="touch-button" id="touchRight" data-key="ArrowRight" aria-label="Move Right">→</button>
        </div>
    </div>
    
    <!-- Game Scripts -->
    <script>
        /**
         * Space Invaders Game Initialization
         * Handles canvas setup, loading screen, error handling, and touch controls
         */
        
        // Global game state and configuration
        window.SpaceInvaders = {
            canvas: null,
            ctx: null,
            isLoading: true,
            hasError: false,
            isMobile: false,
            pixelRatio: window.devicePixelRatio || 1,
            loadingProgress: 0,
            touchControls: new Map(),
            
            // Performance monitoring
            performance: {
                startTime: performance.now(),
                loadTime: 0,
                frameCount: 0,
                lastFrameTime: 0
            },
            
            // Feature detection
            features: {
                canvas: false,
                webgl: false,
                audioContext: false,
                localStorage: false,
                touchEvents: false,
                gamepad: false
            }
        };
        
        /**
         * Initialize the game application
         * Sets up canvas, detects features, and starts loading process
         */
        function initializeGame() {
            try {
                // Feature detection
                detectFeatures();
                
                // Setup canvas and context
                setupCanvas();
                
                // Setup event listeners
                setupEventListeners();
                
                // Setup touch controls for mobile
                setupTouchControls();
                
                // Start loading process
                startLoadingProcess();
                
                // Log initialization success
                console.log('Space Invaders initialized successfully', {
                    features: window.SpaceInvaders.features,
                    isMobile: window.SpaceInvaders.isMobile,
                    pixelRatio: window.SpaceInvaders.pixelRatio
                });
                
            } catch (error) {
                handleError('Initialization failed', error);
            }
        }
        
        /**
         * Detect browser features and capabilities
         */
        function detectFeatures() {
            const features = window.SpaceInvaders.features;
            
            // Canvas support
            const canvas = document.createElement('canvas');
            features.canvas = !!(canvas.getContext && canvas.getContext('2d'));
            
            // WebGL support
            try {
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                features.webgl = !!gl;
            } catch (e) {
                features.webgl = false;
            }
            
            // Audio Context support
            features.audioContext = !!(window.AudioContext || window.webkitAudioContext);
            
            // Local Storage support
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                features.localStorage = true;
            } catch (e) {
                features.localStorage = false;
            }
            
            // Touch events support
            features.touchEvents = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            // Gamepad support
            features.gamepad = 'getGamepads' in navigator;
            
            // Mobile detection
            window.SpaceInvaders.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || features.touchEvents;
        }
        
        /**
         * Setup canvas element and rendering context
         */
        function setupCanvas() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            if (!canvas || !ctx) {
                throw new Error('Canvas or context not available');
            }
            
            // Store references
            window.SpaceInvaders.canvas = canvas;
            window.SpaceInvaders.ctx = ctx;
            
            // Setup high DPI support
            setupHighDPI(canvas, ctx);
            
            // Setup canvas properties
            ctx.imageSmoothingEnabled = false;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Resize canvas to fit screen on mobile
            if (window.SpaceInvaders.isMobile) {
                resizeCanvasForMobile();
            }
        }
        
        /**
         * Setup high DPI display support
         */
        function setupHighDPI(canvas, ctx) {
            const pixelRatio = window.SpaceInvaders.pixelRatio;
            
            if (pixelRatio > 1) {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * pixelRatio;
                canvas.height = rect.height * pixelRatio;
                ctx.scale(pixelRatio, pixelRatio);
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
            }
        }
        
        /**
         * Resize canvas for mobile devices
         */
        function resizeCanvasForMobile() {
            const canvas = window.SpaceInvaders.canvas;
            const container = document.getElementById('gameContainer');
            
            function resize() {
                const containerRect = container.getBoundingClientRect();
                const aspectRatio = 800 / 600; // Game aspect ratio
                
                let width = containerRect.width;
                let height = containerRect.height;
                
                // Maintain aspect ratio
                if (width / height > aspectRatio) {
                    width = height * aspectRatio;
                } else {
                    height = width / aspectRatio;
                }
                
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
            }
            
            resize();
            window.addEventListener('resize', resize);
            window.addEventListener('orientationchange', () => {
                setTimeout(resize, 100); // Delay for orientation change
            });
        }
        
        /**
         * Setup event listeners for game controls and window events
         */
        function setupEventListeners() {
            // Keyboard events
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // Window events
            window.addEventListener('resize', handleResize);
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // Visibility API for pause/resume
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Error handling
            window.addEventListener('error', handleGlobalError);
            window.addEventListener('unhandledrejection', handleUnhandledRejection);
            
            // Context menu prevention on canvas
            window.SpaceInvaders.canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
        }
        
        /**
         * Setup touch controls for mobile devices
         */
        function setupTouchControls() {
            if (!window.SpaceInvaders.isMobile) return;
            
            const touchButtons = document.querySelectorAll('.touch-button');
            
            touchButtons.forEach(button => {
                const key = button.dataset.key;
                
                // Touch start
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    button.classList.add('pressed');
                    window.SpaceInvaders.touchControls.set(key, true);
                    
                    // Simulate keydown event
                    const keyEvent = new KeyboardEvent('keydown', {
                        key: key === 'Space' ? ' ' : key,
                        code: key === 'Space' ? 'Space' : key,
                        keyCode: getKeyCode(key)
                    });
                    document.dispatchEvent(keyEvent);
                }, { passive: false });
                
                // Touch end
                button.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    button.classList.remove('pressed');
                    window.SpaceInvaders.touchControls.set(key, false);
                    
                    // Simulate keyup event
                    const keyEvent = new KeyboardEvent('keyup', {
                        key: key === 'Space' ? ' ' : key,
                        code: key === 'Space' ? 'Space' : key,
                        keyCode: getKeyCode(key)
                    });
                    document.dispatchEvent(keyEvent);
                }, { passive: false });
                
                // Prevent default touch behaviors
                button.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                }, { passive: false });
            });
        }
        
        /**
         * Get key code for touch control simulation
         */
        function getKeyCode(key) {
            const keyCodes = {
                'ArrowLeft': 37,
                'ArrowRight': 39,
                'Space': 32
            };
            return keyCodes[key] || 0;
        }
        
        /**
         * Start the loading process with progress updates
         */
        function startLoadingProcess() {
            const loadingSteps = [
                { name: 'Initializing game engine...', duration: 200 },
                { name: 'Loading game assets...', duration: 500 },
                { name: 'Setting up audio system...', duration: 300 },
                { name: 'Preparing game world...', duration: 400 },
                { name: 'Finalizing setup...', duration: 200 }
            ];
            
            let currentStep = 0;
            let totalProgress = 0;
            
            function executeStep() {
                if (currentStep >= loadingSteps.length) {
                    completeLoading();
                    return;
                }
                
                const step = loadingSteps[currentStep];
                updateLoadingText(step.name);
                
                // Simulate loading step
                setTimeout(() => {
                    totalProgress += (100 / loadingSteps.length);
                    updateLoadingProgress(Math.min(totalProgress, 100));
                    currentStep++;
                    executeStep();
                }, step.duration);
            }
            
            executeStep();
        }
        
        /**
         * Update loading screen text
         */
        function updateLoadingText(text) {
            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = text;
            }
        }
        
        /**
         * Update loading progress bar
         */
        function updateLoadingProgress(progress) {
            window.SpaceInvaders.loadingProgress = progress;
            const progressBar = document.getElementById('loadingProgressBar');
            const progressElement = progressBar.parentElement;
            
            if (progressBar && progressElement) {
                progressBar.style.width = progress + '%';
                progressElement.setAttribute('aria-valuenow', Math.round(progress));
            }
        }
        
        /**
         * Complete loading process and start game
         */
        function completeLoading() {
            window.SpaceInvaders.isLoading = false;
            window.SpaceInvaders.performance.loadTime = performance.now() - window.SpaceInvaders.performance.startTime;
            
            // Hide loading screen
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
            
            // Start game loop
            startGameLoop();
            
            console.log('Game loaded successfully', {
                loadTime: window.SpaceInvaders.performance.loadTime,
                features: window.SpaceInvaders.features
            });
        }
        
        /**
         * Start the main game loop
         */
        function startGameLoop() {
            let lastTime = 0;
            
            function gameLoop(currentTime) {
                const deltaTime = currentTime - lastTime;
                lastTime = currentTime;
                
                // Update performance metrics
                window.SpaceInvaders.performance.frameCount++;
                window.SpaceInvaders.performance.lastFrameTime = deltaTime;
                
                // Clear canvas
                const ctx = window.SpaceInvaders.ctx;
                const canvas = window.SpaceInvaders.canvas;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Render loading complete message (temporary)
                ctx.fillStyle = '#00ff00';
                ctx.font = '24px Courier New';
                ctx.fillText('Space Invaders Ready!', canvas.width / 2, canvas.height / 2 - 50);
                
                ctx.font = '16px Courier New';
                ctx.fillText('Game engine initialized successfully', canvas.width / 2, canvas.height / 2);
                ctx.fillText(`Load time: ${Math.round(window.SpaceInvaders.performance.loadTime)}ms`, canvas.width / 2, canvas.height / 2 + 30);
                ctx.fillText('Press SPACE to continue', canvas.width / 2, canvas.height / 2 + 60);
                
                // Continue game loop
                requestAnimationFrame(gameLoop);
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        /**
         * Handle keyboard input
         */
        function handleKeyDown(event) {
            // Prevent default for game keys
            if (['ArrowLeft', 'ArrowRight', 'Space'].includes(event.code)) {
                event.preventDefault();
            }
            
            // Log key press for debugging
            console.log('Key pressed:', event.code);
        }
        
        function handleKeyUp(event) {
            // Prevent default for game keys
            if (['ArrowLeft', 'ArrowRight', 'Space'].includes(event.code)) {
                event.preventDefault();
            }
        }
        
        /**
         * Handle window resize
         */
        function handleResize() {
            if (window.SpaceInvaders.isMobile) {
                resizeCanvasForMobile();
            }
        }
        
        /**
         * Handle page unload
         */
        function handleBeforeUnload(event) {
            // Save game state if needed
            console.log('Game session ending');
        }
        
        /**
         * Handle visibility change (tab switching)
         */
        function handleVisibilityChange() {
            if (document.hidden) {
                console.log('Game paused (tab hidden)');
            } else {
                console.log('Game resumed (tab visible)');
            }
        }
        
        /**
         * Handle global errors
         */
        function handleGlobalError(event) {
            console.error('Global error:', event.error);
            handleError('Runtime error', event.error);
        }
        
        /**
         * Handle unhandled promise rejections
         */
        function handleUnhandledRejection(event) {
            console.error('Unhandled promise rejection:', event.reason);
            handleError('Promise rejection', event.reason);
        }
        
        /**
         * Handle and display errors
         */
        function handleError(title, error) {
            window.SpaceInvaders.hasError = true;
            
            const errorScreen = document.getElementById('errorScreen');
            const errorMessage = document.getElementById('errorMessage');
            const loadingScreen = document.getElementById('loadingScreen');
            
            if (errorScreen && errorMessage) {
                errorMessage.textContent = error?.message || error || 'An unknown error occurred';
                errorScreen.style.display = 'flex';
            }
            
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            console.error(`${title}:`, error);
        }
        
        // Initialize game when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }
        
        // Export for external access
        window.SpaceInvaders.init = initializeGame;
        window.SpaceInvaders.handleError = handleError;
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        // Register service worker for offline support (if available)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>